<!DOCTYPE html>
{% load static %}
{% load dict_filters %}

<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sárvári Viola</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'main/style.css' %}" rel="stylesheet">
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark mb-0" style="background-color: #001f3f;">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a class="navbar-brand text-white text-wrap" style="font-size: 1.1rem; max-width: 80%;">
            Ország- és régiószintű különbségek statisztikai elemzése Szerbiában és a szomszédos országokban
        </a>
        <span class="text-white d-none d-md-block" style="font-size: 1rem;">
            Készítette: Sárvári Viola
        </span>
    </div>
</nav>


<!-- 1) KEZDŐKÁRTYA -->
{% if not level %}
<div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
    <div class="card shadow p-4" style="max-width: 400px; width: 100%;">
        <h3 class="text-center mb-3">Válassz elemzési szintet</h3>

        <hr style="border-color: rgba(255,255,255,0.15); margin-top: -5px; margin-bottom: 20px;">

        <form method="get">
            <div class="mb-3">
                <input type="radio" name="szint" value="orszag" id="orszag">
                <label for="orszag">Ország szintű elemzés</label>
            </div>

            <div class="mb-3">
                <input type="radio" name="szint" value="regio" id="regio">
                <label for="regio">Régió szintű elemzés</label>
            </div>

            <button class="btn btn-primary w-100 mt-2">Tovább</button>
        </form>
    </div>
</div>
{% endif %}


<!-- 2) MÁSODIK KÁRTYA: VAN SZINT, DE NINCS VÁLTOZÓ -->
{% if level and not selected_var %}
<div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
    <div class="card shadow p-4" style="max-width: 450px; width: 100%;">
        <h3 class="text-center mb-3">
            <div>Elemzési szint:</div>
            <div class="text-primary" style="font-size: 1.8rem; font-weight: 600;">
                {% if level == "orszag" %}Ország{% else %}Régió{% endif %}
            </div>
        </h3>

        <form method="get">
            <input type="hidden" name="szint" value="{{ level }}">

            <label class="mb-2">Válassz változót</label>
            <select name="valtozo" class="form-select mb-3">
                {% for v in variables %}
                    <option value="{{ v }}">{{ DISPLAY_NAMES|get_item:v|default:v }}</option>
                {% endfor %}
            </select>

            <button class="btn btn-success w-100">Elemzés indítása</button>
        </form>
    </div>
</div>
{% endif %}


<!-- 3) TELJES DASHBOARD -->
{% if selected_var %}
<div class="container-fluid">
    <div class="row">

        <!-- SIDEBAR -->
        <div class="col-md-3 sidebar">
            <div class="sidebar-block">
                <h5 class="sidebar-title text-center">Vezérlőpanel</h5>

                <!-- Elemzési szint -->
                <form method="get">
                    <label class="sidebar-label d-block mb-2">Elemzési szint</label>

                    <div class="mb-2">
                        <input type="radio" name="szint" value="orszag" id="side_orszag"
                               {% if level == 'orszag' %}checked{% endif %}>
                        <label for="side_orszag">Ország</label>
                    </div>

                    <div class="mb-2">
                        <input type="radio" name="szint" value="regio" id="side_regio"
                               {% if level == 'regio' %}checked{% endif %}>
                        <label for="side_regio">Régió</label>
                    </div>

                    <button class="btn btn-primary w-100 mt-3">Szűrés</button>
                </form>

                <!-- Változó választó -->
                <form method="get" class="mt-4">
                    <input type="hidden" name="szint" value="{{ level }}">

                    <label class="sidebar-label mt-3">Válassz változót</label>

                    <select name="valtozo" class="sidebar-select">
                        {% for v in variables %}
                            <option value="{{ v }}" {% if selected_var == v %}selected{% endif %}>
                                {{ DISPLAY_NAMES|get_item:v|default:v }}
                            </option>
                        {% endfor %}
                    </select>

                    <button class="btn btn-success w-100 mt-3">Szűrés</button>
                </form>

            </div>
        </div>


        <!-- MAIN CONTENT -->
        <div class="col-md-9 p-4">

            <!-- CÍM -->
            <h2 class="text-white mb-4">
                Eredmények: <span class="text-primary">{{ display_var }}</span>
                {% if paired_display %}
                    <span class="text-secondary" style="font-size: 1rem;">
                        &nbsp;| &nbsp;Párosított változó: {{ paired_display }}
                    </span>
                {% endif %}
            </h2>

            <!-- NORMALITÁS FELÜL -->
            {% if stats.normality %}
                {% if stats.all_normal %}
                    <div class="alert alert-success mb-4">
                        A normalitási feltételek teljesülnek.
                        <strong>Az ANOVA eredményei megbízhatóak.</strong>
                    </div>
                {% else %}
                    <div class="alert alert-danger mb-4">
                        Több ország/régió nem normális eloszlású.
                        <strong>Az ANOVA eredményei bizonytalanok.</strong>
                    </div>
                {% endif %}
            {% endif %}

            <!-- NORMALITÁSI LISTA -->
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">Normalitás vizsgálat (Shapiro–Wilk)</div>

                <div class="card-body">
                    {% if stats.normality %}
                        <ul class="list-group">
                            {% for item in stats.normality %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <div>
                                    <strong class="normality-title">
                                        {% if item.country %}{{ item.country }}{% else %}{{ item.region }}{% endif %}
                                    </strong>
                                    <br>
                                    <small class="normality-result">
                                        W = {{ item.w }} • p = {{ item.p }}
                                    </small>
                                </div>

                                {% if item.normal %}
                                    <span class="badge bg-success rounded-pill">Normális</span>
                                {% else %}
                                    <span class="badge bg-danger rounded-pill">Nem normális</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>

                    {% else %}
                        <p class="text-muted">Ehhez a változóhoz nincs adat.</p>
                    {% endif %}
                </div>
            </div>


            <!-- ANOVA KÁRTYÁK – KÉT VÁLTOZÓ EGYMÁS MELLÉ -->
            {% if stats.anova or paired_anova %}
            <div class="row mb-4">

                {% if stats.anova %}
                <div class="col-md-6">
                    <div class="stat-card shadow mb-3">
                        <h6>{{ display_var }} – ANOVA F-érték</h6>
                        <p class="value">{{ stats.anova.f_value }}</p>
                        <small>A csoportok közötti eltérés mértéke.</small>
                    </div>

                    <div class="stat-card shadow
                        {% if stats.anova.p_value == '<.0001' or stats.anova.p_float < 0.05 %}
                            stat-border-good
                        {% else %}
                            stat-border-bad
                        {% endif %}
                    ">
                        <h6>Szignifikancia (p-érték)</h6>
                        <p class="value">{{ stats.anova.p_value }}</p>
                    </div>
                </div>
                {% endif %}

                {% if paired_anova %}
                <div class="col-md-6">
                    <div class="stat-card shadow mb-3">
                        <h6>{{ paired_display }} – ANOVA F-érték</h6>
                        <p class="value">{{ paired_anova.f_value }}</p>
                        <small>A csoportok közötti eltérés mértéke.</small>
                    </div>

                    <div class="stat-card shadow
                        {% if paired_anova.p_value == '<.0001' or paired_anova.p_float < 0.05 %}
                            stat-border-good
                        {% else %}
                            stat-border-bad
                        {% endif %}
                    ">
                        <h6>Szignifikancia (p-érték)</h6>
                        <p class="value">{{ paired_anova.p_value }}</p>
                    </div>
                </div>
                {% endif %}

            </div>
            {% endif %}


            <!-- ÁBRÁK – KÉT VÁLTOZÓ EGYMÁS MELLÉ -->
            {% if image_path or paired_image_path %}
            <div class="row">

                <div class="col-md-6">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-secondary text-white">{{ display_var }} – Eredmények Ábrája</div>
                        <div class="card-body text-center">
                            {% if image_path %}
                                <img src="{% static image_path %}" class="img-fluid rounded shadow">
                            {% else %}
                                <p class="text-muted">Nincs elérhető ábra.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if paired_image_path %}
                <div class="col-md-6">
                    <div class="card shadow mb-4">
                        <div class="card-header bg-secondary text-white">{{ paired_display }} – Eredmények Ábrája</div>
                        <div class="card-body text-center">
                            <img src="{% static paired_image_path %}" class="img-fluid rounded shadow">
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
            {% endif %}

        </div>
    </div>
</div>
{% endif %}


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
